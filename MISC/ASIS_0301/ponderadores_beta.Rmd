---
title: "Propuesta de ponderadores longitudinales"
author: "Equipo de asistentes ELSOC"
output:
  xaringan::moon_reader:
    css: [xaringan-themer.css]
    seal: FALSE 
---

class: middle,center
```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
library(tidyverse)
library(kableExtra)
library(plotly)
library(gee)
library(geepack)

options(knitr.table.format = "html") 
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)
style_mono_accent(
  base_color = '#21918c',
  header_font_google = google_font("Josefin Sans"),
  text_font_google   = google_font("Montserrat", "300", "300i"),
  code_font_google   = google_font("Fira Mono"),
  extra_css = list(
  ".small" = list("font-size" = "75%")),
  colors = c(
  azul = '#3b528b',
  morado = '#440154',
  amarillo = '#fde725',
  verde = '#21918c',
  white = "#FFFFFF"
))
```

```{css}
.tabla {
  font-size: 13px;
}
```


<h1> .morado[Ponderadores longitudinales] </h1>

<img src="../../IMG/ELSOC.jpeg" width="px"/>

**.large[ Version BETA | COES | Enero 2023]**
---
<h1> .morado[Estructura presentación] </h1>

<ul>
  <li>¿Qué es un ponderador longitudinal?</li>
      <ul>
      <li>Características heredadas de los pesos transversales</li>
    </ul>
  <li>Modelamiento No Respuesta
    <ul>
      <li>Ventajas y desventajas modelos glm vía GEE</li>
      <li>Modelo ajustado para m1 y m2</li>
    </ul>
  </li>
  <li>Recorte a los pesos</li>
  <li>Calibración</li>    
  <ul>
      <li>Proyecciones de población INE</li>
      <li>Raking</li>
  </ul>
  <li>Limitaciones pesos longitudinales</li>  
</ul>

---
class: inverse,middle,center
<h1> Resumen Ejecutivo </h1>

---
<h1> .morado[Resumen ejecutivo] </h1>

Los ponderadores longitudinales toman los pesos originales y se le aplican una serie de transformaciones: 

Ajuste en base a la probabilidad de participación de un individuo en un año en particular a  a partir de la segunda ola de cada muestra. 

Recorte de los valores extremos considerando el  90% central de la distribución empírica de los pesos. 

Los ajustes a totales poblacionales: Proyecciones poblaciones de sexo y tramos etarios

Se construyen dos ponderadores:  1) Total de observaciones, 2) Uso con paneles balanceados.
---

<h1> .morado[Resumen ejecutivo] </h1>

Para modelar la probabilidad de respuesta se ocupa una regresión logística mediante GEE.También se hacen dos modelos distintos para cada muestra. Para escoger las variables relevantes a incluir en el modelo se hace un algoritmo de selección backward. 

El ajuste a totales poblacionales se hace vía raking: Solución iterativa que permite ajustar totales marginales de sexo y tramos etarios. Al mismo tiempo se limita la población urbana mayor de 18 años. 

Se hace un re-escalamiento de los pesos para que puedan reproducir totales poblacionales.

Las limitaciones más importantes de los pesos tenen que ver con no considerar la elegibilidad de la persona a la hora de hacer un ajuste de no respuesta. 

---
<h1> .morado[¿Qué son los ponderadores longitudinales?] </h1>

Son transformaciones de los pesos originales de ELSOC.

<ul>
  <li>Pesos <b>.morado[transversales:]</b></li>
      <ul>
      <li> Inverso P. Selección </li>
      <li> Ajuste de NR (2016 y 2018) </li>
      <li>PS Región y Sexo</li>
      <li>Re-escalamientos</li>
    </ul>
  <li>Pesos  <b>.morado[longitudinales:]</b></li>
      <ul>
      <li>Inverso P. Selección</li>
      <li>Ajuste de NR (2016 y 2018)</li>
      <li>Ajuste NR (2017 hasta 2022)</li>
      <li>Recorte a los pesos</li>
      <li>Calibración Edad y Sexo</li>
      <li>Re-escalamientos</li>

---
<h1> .morado[Características heredadas de los pesos transversales] </h1>

Los pesos longitudinales mantienen el cálculo del inverso de la probabilidad de selección. Al mismo tiempo se mantiene el ajuste de no respuesta de la primera ola de cada muestra.

Inverso de probabilidad de selección:

Ajuste de no respuesta de la primera ola:

---
class: inverse,middle,center
<h1> Ajuste por Atrición </h1>

---
<h1> .morado[Modelamiento de la no respuesta] </h1>

Consideramos como atrición el proceso por el cual un individuo que respondió en la primera ola de cada muestra no participa del estudio en alguna o todas las olas posteriores. 

La existencia de patrones sistemáticos en la no participación de los entrevistados puede introducir sesgo en las estimaciones. 

El ajuste por atrición consiste utilizar las probabilidades predichas por un modelo para darle más importancia a las observaciones que comparten características con los participantes que dejan participar del estudio. 

La probabilidad que una persona responda en un año particular es modelada separadamente para la muestra original y la muestra de refresco.

Se asume que la muestra original y la muestra de refresco tienen procesos de atrición distintos. Esto además evita imputar valores para la muestra de refresco en los años 2016 y 2027
---
<h1> .morado[Técnica de modelamiento de la no respuesta] </h1>

Glm vía GEE: Permiten trabajar con observaciones correlacionadas.

Ventajas: 1) Permiten dar estructura autorregresiva a las observaciones dentro de un mismo individuo. 2) Son rápidos de calcular y usualmente no presentan problemas de convergencia como los glmmm.

Desventajas: Estos modelos se limitan a un único nivel de anidamiento. Es decir, sólo  podemos considerar la correlación entre observaciones de un mismo individuo en distintos puntos del tiempo, pero no entre individuos dentro de un mismo barrio, o entre individuos dentro de una misma ciudad. 

Para escoger el mejor subconjunto de covariables se utilizó un método de selección backward, y cómo criterio de ajuste, se utilizó un análogo del AIC para los GEE (QICu).
---
<h1> .morado[Covariables del modelo] </h1>

Tres fuentes de información: 

<ul>
  <li>Cuestionario:</li>
      <ul>
      <li>Estrato diseño muestral, Nivel Educacional, Sexo, Tramo etario y Estado Civil.</li>
    </ul>
  <li>Información territorial:
    <ul>
      <li>Densidad poblacional, Escolaridad promedio jefes de hogar, Proporción de viviendas en condición de hacinamiento, Proporción de viviendas en situación precaria, Tamaño de hogar promedio y Cantidad promedio de personas por hogar.</li>
    </ul>
  </li>
  <li>Proceso de recolección de datos:</li>
      <ul>
      <li>Número de items con nsnr promedio por módulo, Número de visitas en el año anterior.</li>
    </ul>
</ul>

---
class: tabla
<h1> .morado[Modelo ajustado muestra original] </h1>


```{r}
bestGEE_QICU <- readRDS("../../modelamiento NR/modelos/bestGEE_QICU.RDS")
bestGEE_QICU_m2 <- readRDS("../../modelamiento NR/modelos/bestGEE_QICU_m2.RDS")

```

```{r}
tabla_m1 <- broom::tidy(bestGEE_QICU)
tabla_m2 <- broom::tidy(bestGEE_QICU_m2)
```


```{r}
unicos_variables<-  c("Intercepto", 
                      "Soltero",
                      "Densidad poblacional zc",
                      "30 a 44 años",
                      "45 a 59 años", 
                      "60 o más",
                      "Educ. Media",
                      "Educ. Técnica",
                      "Educ. Universitaria",
                      "C. Medianas",
                      "C. Pequeñas",
                      "G. Concepción",
                      "G. Santiago",
                      "G. Valparaiso",
                      "Escolaridad jh zc",
                      "NSNR 1ra ola",
                      "2018",
                      "2019", 
                      "2021",
                      "2022",
                      "P. Viviendas precarias zc",
                      "Mujer",
                      "Tamaño hogar prom. zc",
                      "Visitas ola anterior")



names(unicos_variables) <-  c(tabla_m2$term,tabla_m1$term)%>%
                 unique()%>%
                 sort()

tabla_m1$term <- dplyr::recode(tabla_m1$term,!!!unicos_variables)
tabla_m2$term <- dplyr::recode(tabla_m2$term,!!!unicos_variables)


```



```{r}
tabla_m1%>%
  select(-statistic)%>%
  mutate(across(c(estimate,std.error), ~round(.x,4)),
         sig=case_when(p.value <0.01 ~ '***',
                       p.value >0.01 & p.value <0.05 ~'**',
                       p.value >0.05 & p.value <0.1 ~'*',
                       p.value >.1 ~''))%>%
  select(-p.value)%>%
            rename(Variable=term,Coeficiente=estimate,`Err. Estándar`=std.error,Significancia=sig)%>%
DT::datatable()
```


---
class: tabla
<h1> .morado[Modelo ajustado muestra de refresco] </h1>

```{r}
tabla_m2%>%
  select(-statistic)%>%
  mutate(across(c(estimate,std.error), ~round(.x,4)),
         sig=case_when(p.value <0.01 ~ '***',
                       p.value >0.01 & p.value <0.05 ~'**',
                       p.value >0.05 & p.value <0.1 ~'*',
                       p.value >.1 ~''))%>%
  select(-p.value)%>%
            rename(Variable=term,Coeficiente=estimate,`Err. Estándar`=std.error,Significancia=sig)%>%
DT::datatable()
```



---
<h1> .morado[Recorte de los pesos] </h1>

Un problema de los pesos originales es que posee valores extremos importantes, especialmente luego del ajuste de no respuesta, dichos valores se dan en ambas colas de la distribución. 

Se toma la decisión de recortar el 10% más extremo de la distribución de los pesos.

Es decir, los valores que sean inferiores al percentil 5 o que sean mayores al 95 son reemplazados el valor de dichos percentiles respectivamente. De esta manera se evita tener pesos con observaciones perdidas. 

---

<h1> .morado[Calibración] </h1>

Es una de las formas de hacer coincidir las estimaciones muestrales con valores totales conocidos para la población. 


Los pesos transversales se post-estratifican según totales por región y por sexo. Los pesos longitudinales se calibran respecto a los totales poblacionales para las variables de sexo y tramo etario.

Estos totales corresponden a las proyecciones hechas por el INE para la población mayor de 18 años de zonas urbanas.

---
<h1> .morado[Raking] </h1>

Puede pensarse como una post-estratificación iterativa sobre cada una de las variables auxiliares de interes. 

Como ventaja respecto a la post-estratificación es que no se requiere de valores para todos las combinaciones posibles de categorías de las variables auxiliares, y también se evitan valores extremos debido a combinaciones con pocas observaciones. 

El ponderador longitudinal total calibra las proporciones muestrales de todas las observaciones del estudio a los totales poblacionales conocidos. El ponderador longitudinal panel hace lo mismo pero para el subconjunto de observaciones que responden a todas olas. 

Se ocupa la funcion `rake()` de la librería `survey` para cada año 

---
<h1> .morado[Re-escalamientos] </h1>

Re-escalar los pesos hace que la suma de los ponderadores sea equivalente al tamaño muestral. 

Esto permite darle una interpretación al valor del peso de una observación

Se hace un re-escalamiento para cada año, y cada peso longitudinal reproduce tamaños muestrales distintos. 

`ponderadorlg_total` reproduce por año el tamaño muestral total de ELSOC, mientras que  `ponderadorlg_panel` reproduce el tamaño muestral del panel balanceado, para cada muestra.

---
class: inverse,middle,center
<h1> Demostración de los pesos </h1>
---

<h1> .morado[Totales poblacionales] </h1>

<iframe src='graficos/gf_ine_proy_sexo.html' width="100%" height="400" id="igraph" scrolling="no" seamless="seamless" frameBorder="0"> </iframe>
---
<h1> .morado[Totales poblacionales] </h1>

<iframe src='graficos/gf_ine_proy_tramo.html' width="100%" height="400" id="igraph" scrolling="no" seamless="seamless" frameBorder="0"> </iframe>
---
<h1> .morado[Proporciones muestrales] </h1>

<iframe src='graficos/gf_tramo_etario_muestral_ponderado.html' width="100%" height="400" id="igraph" scrolling="no" seamless="seamless" frameBorder="0"> </iframe>


---
<h1> .morado[Proporciones muestrales] </h1>

<iframe src='graficos/gf_sexo_muestral_ponderado.html' width="100%" height="400" id="igraph" scrolling="no" seamless="seamless" frameBorder="0"> </iframe>

---
<h1> .morado[Aplicación ponderadores] </h1>

<iframe src='graficos/satis_demo_ponderadores.html' width="100%" height="400" id="igraph" scrolling="no" seamless="seamless" frameBorder="0"> </iframe>

---
<h1> .morado[Limitaciones] </h1>

Los ponderadores transversales y los longitudinales no consideran la elegilibilidad de los entrevistados a la hora de hacer un ajuste de no respuesta. 

Dado que la calibración y los re-escalamientos dependen de la sub-muestra particular con la que se trabaje, usuarios que ocupen otras combinaciones de olas, podrían tener sesgo en sus observaciones.


---
<h1> .azul[Posibles ajustes futuros] </h1>

Las funciones del paquete `survey` permiten poner cotas superiores e inferiores a los ajustes que se hace en la etapa de calibración.

Podría considerarse agregar la variable nivel educacional a la calibración, la cuál tiene únicamente un total para el año 2017.